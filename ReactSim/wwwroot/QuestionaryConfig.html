<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuração do Cenário (ReactSim)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-title h1 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .header-subtitle {
            font-size: 13px;
            color: #bdc3c7;
        }

        .btn-save {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

            .btn-save:hover {
                background: #c0392b;
            }

        .container {
            display: flex;
            height: calc(100vh - 80px);
        }

        .sidebar {
            width: 240px;
            background: white;
            border-right: 1px solid #e0e0e0;
            padding: 20px;
            overflow-y: auto;
        }

        .sidebar-section {
            margin-bottom: 24px;
        }

        .sidebar-title {
            font-size: 11px;
            font-weight: 700;
            color: #95a5a6;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .sidebar-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .question-list {
            list-style: none;
        }

        .question-item {
            padding: 10px 12px;
            margin-bottom: 4px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            color: #555;
            transition: background 0.2s;
        }

            .question-item:hover {
                background: #f8f9fa;
            }

            .question-item.active {
                background: #fee;
                color: #e74c3c;
                border-left: 3px solid #e74c3c;
                padding-left: 9px;
            }

        .question-number {
            display: inline-block;
            width: 20px;
            font-weight: 600;
        }

        .btn-add {
            width: 100%;
            padding: 10px;
            border: 1px dashed #bdc3c7;
            background: white;
            border-radius: 4px;
            color: #7f8c8d;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

            .btn-add:hover {
                border-color: #95a5a6;
                color: #555;
            }

        .main-content {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 32px;
        }

        .section-number {
            background: #e74c3c;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
        }

        .section-header h2 {
            font-size: 24px;
            color: #2c3e50;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e74c3c;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }

        .form-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            min-height: 100px;
            font-family: inherit;
            resize: vertical;
            background: white;
            color: #2c3e50;
        }

            .form-textarea:focus {
                outline: none;
                border-color: #3498db;
            }

        .options-section {
            margin-top: 32px;
        }

        .option-item {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .option-number {
            font-size: 12px;
            color: #95a5a6;
            width: 20px;
        }

        .radio-btn {
            width: 20px;
            height: 20px;
            border: 2px solid #bdc3c7;
            border-radius: 50%;
            cursor: pointer;
            flex-shrink: 0;
            position: relative;
        }

            .radio-btn.checked {
                border-color: #e74c3c;
            }

                .radio-btn.checked::after {
                    content: '';
                    position: absolute;
                    width: 10px;
                    height: 10px;
                    background: #e74c3c;
                    border-radius: 50%;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                }

        .option-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            color: #2c3e50;
        }

            .option-input:focus {
                outline: none;
                border-color: #3498db;
            }

            .option-input.correct {
                background: #e8f8f5;
                border-color: #27ae60;
            }

        .btn-delete {
            padding: 8px 12px;
            background: transparent;
            border: none;
            color: #95a5a6;
            cursor: pointer;
            border-radius: 4px;
        }

            .btn-delete:hover {
                background: #f8f9fa;
                color: #e74c3c;
            }

        .btn-add-option {
            background: transparent;
            border: none;
            color: #3498db;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            padding: 8px 0;
            display: flex;
            align-items: center;
            gap: 6px;
        }

            .btn-add-option:hover {
                color: #2980b9;
            }

        .info-box {
            background: #e8f4fd;
            border: 1px solid #b8dff5;
            border-radius: 6px;
            padding: 16px;
            margin-top: 24px;
            display: flex;
            gap: 12px;
            color: #2c3e50;
            font-size: 14px;
            line-height: 1.5;
        }

        .info-icon {
            color: #3498db;
            flex-shrink: 0;
        }

        .settings-icon {
            font-size: 24px;
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

            .loading-overlay.active {
                display: flex;
            }

        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 12px;
            text-align: center;
            max-width: 400px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #ecf0f1;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            color: #2c3e50;
            font-size: 16px;
            font-weight: 600;
        }

        .api-config {
            margin-bottom: 16px;
        }

        .api-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            margin-top: 4px;
        }

        .api-label {
            font-size: 11px;
            font-weight: 600;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .competencias-container {
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 12px;
            background: white;
            min-height: 120px;
        }

        .competencias-selected-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            min-height: 40px;
            padding: 8px;
            border: 2px dashed #ddd;
            border-radius: 6px;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.2s;
        }

            .competencias-selected-tags:hover {
                border-color: #3498db;
                background: #f0f8ff;
            }

            .competencias-selected-tags.empty::before {
                content: 'Clique para selecionar competências...';
                color: #95a5a6;
                font-size: 14px;
            }

        .competencia-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            color: white;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

            .competencia-tag:hover {
                filter: brightness(0.9);
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            }

        .competencia-tag-remove {
            cursor: pointer;
            font-weight: bold;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

            .competencia-tag-remove:hover {
                opacity: 1;
            }

        .competencias-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 4px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            max-height: 300px;
            overflow-y: auto;
            z-index: 100;
        }

            .competencias-dropdown.active {
                display: block;
            }

        .competencia-option {
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
        }

            .competencia-option::before {
                content: '';
                position: absolute;
                left: 0;
                top: 0;
                bottom: 0;
                width: 4px;
                background: transparent;
                transition: background 0.2s;
            }

            .competencia-option:last-child {
                border-bottom: none;
            }

            .competencia-option:hover {
                background: #f8f9fa;
            }

            .competencia-option.selected {
                background: #f8f9fa;
                font-weight: 500;
            }

                .competencia-option.selected::before {
                    background: var(--competencia-color, #3498db);
                }

        .competencia-option-check {
            width: 20px;
            height: 20px;
            border: 2px solid #ddd;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s;
        }

        .competencia-option.selected .competencia-option-check {
            background: var(--competencia-color, #3498db);
            border-color: var(--competencia-color, #3498db);
            color: white;
        }

        .competencia-option-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .competencia-option-nome {
            font-size: 14px;
            color: #2c3e50;
        }

        .competencia-option-id {
            font-size: 11px;
            color: #95a5a6;
            font-weight: 500;
        }

        .competencia-color-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .competencias-wrapper {
            position: relative;
        }

        .competencias-search {
            padding: 12px 16px;
            border-bottom: 2px solid #f0f0f0;
            background: #fafafa;
        }

            .competencias-search input {
                width: 100%;
                padding: 8px 12px;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 14px;
            }

                .competencias-search input:focus {
                    outline: none;
                    border-color: #3498db;
                }

        .no-competencias {
            padding: 20px;
            text-align: center;
            color: #95a5a6;
            font-size: 14px;
        }

        .btn-load-competencias {
            margin-top: 8px;
            padding: 8px 12px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            width: 100%;
            font-weight: 600;
        }

            .btn-load-competencias:hover {
                background: #2980b9;
            }

            .btn-load-competencias:disabled {
                background: #bdc3c7;
                cursor: not-allowed;
            }

        .competencias-loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
            font-size: 13px;
        }

        .competencias-error {
            text-align: center;
            padding: 20px;
            color: #e74c3c;
            font-size: 13px;
        }

        .media-section {
            margin-top: 32px;
            padding-top: 32px;
            border-top: 1px solid #e0e0e0;
        }

        .media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .media-item {
            position: relative;
            border: 2px dashed #ddd;
            border-radius: 8px;
            overflow: hidden;
            aspect-ratio: 16/9;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
        }

            .media-item img, .media-item video {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

        .media-item-empty {
            cursor: pointer;
            transition: all 0.3s;
        }

            .media-item-empty:hover {
                border-color: #3498db;
                background: #f0f8ff;
            }

        .media-upload-icon {
            font-size: 48px;
            color: #bdc3c7;
        }

        .media-delete {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(231, 76, 60, 0.9);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .media-item:hover .media-delete {
            opacity: 1;
        }

        .media-delete:hover {
            background: rgba(192, 57, 43, 1);
        }

        .media-type-badge {
            position: absolute;
            bottom: 8px;
            left: 8px;
            background: rgba(52, 152, 219, 0.9);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .btn-add-media {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: white;
            border: 2px dashed #3498db;
            border-radius: 6px;
            color: #3498db;
            font-weight: 600;
            cursor: pointer;
            margin-top: 16px;
            transition: all 0.2s;
        }

            .btn-add-media:hover {
                background: #f0f8ff;
                border-color: #2980b9;
            }

        .file-input-hidden {
            display: none;
        }

        .media-url-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 8px;
        }

            .media-url-input:focus {
                outline: none;
                border-color: #3498db;
            }

        .media-type-select {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            margin-right: 8px;
            cursor: pointer;
        }

            .media-type-select:focus {
                outline: none;
                border-color: #3498db;
            }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

            .modal.active {
                display: flex;
            }

        .modal-content {
            background: white;
            padding: 32px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn-modal {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-cancel {
            background: #ecf0f1;
            color: #7f8c8d;
        }

            .btn-cancel:hover {
                background: #bdc3c7;
            }

        .btn-confirm {
            background: #3498db;
            color: white;
        }

            .btn-confirm:hover {
                background: #2980b9;
            }

        .media-item-content {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

            .media-item-content iframe {
                width: 100%;
                height: 100%;
                border: none;
            }

        .media-error {
            color: #e74c3c;
            font-size: 12px;
            text-align: center;
            padding: 8px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <span class="settings-icon">⚙️</span>
            <div class="header-title">
                <h1>Configuração do Cenário (ReactSim)</h1>
                <div class="header-subtitle">Editor de Questões Múltiplas</div>
            </div>
        </div>
        <button class="btn-save">
            💾 Guardar Alterações
        </button>
    </div>

    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title">Global Settings</div>
                <input type="text" class="sidebar-input" value="Chefe de Grupo" placeholder="Nome do grupo">
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Configuração API</div>
                <div class="api-config">
                    <label class="api-label">URL API Competências</label>
                    <input type="text" class="api-input" id="api-competencias-url" placeholder="https://api.exemplo.com/competencias" value="https://api.exemplo.com/competencias">
                </div>
                <button class="btn-load-competencias" id="btn-load-competencias" onclick="carregarCompetencias()">
                    🔄 Carregar Competências
                </button>
                <div class="api-config" style="margin-top: 16px;">
                    <label class="api-label">URL API Questões</label>
                    <input type="text" class="api-input" id="api-url" placeholder="https://api.exemplo.com/questoes" value="https://api.exemplo.com/questoes">
                </div>
                <div class="api-config">
                    <label class="api-label">API Key (Opcional)</label>
                    <input type="text" class="api-input" id="api-key" placeholder="sua-api-key-aqui">
                </div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Questões (<span id="question-count">2</span>)</div>
                <ul class="question-list" id="question-list">
                    <li class="question-item" data-question="1" onclick="carregarQuestao(1)">
                        <span class="question-number">1</span>
                        Gestão de Recursos e ...
                    </li>
                    <li class="question-item active" data-question="2" onclick="carregarQuestao(2)">
                        <span class="question-number">2</span>
                        Liderança sob Pressã...
                    </li>
                </ul>
                <button class="btn-add" onclick="adicionarQuestao()">
                    + Adicionar Questão
                </button>
            </div>
        </aside>

        <main class="main-content">
            <div class="section-header">
                <div class="section-number" id="current-question-number">2</div>
                <h2>Editar Questão</h2>
            </div>

            <div class="form-group">
                <label class="form-label">Competências a Avaliar</label>
                <div class="competencias-wrapper">
                    <div class="competencias-container">
                        <div class="competencias-selected-tags empty" id="competencias-tags" onclick="toggleCompetenciasDropdown()">
                            <!-- Tags serão adicionadas aqui -->
                        </div>
                        <div class="competencias-dropdown" id="competencias-dropdown">
                            <div class="competencias-search">
                                <input type="text" placeholder="🔍 Pesquisar competências..." id="competencias-search" oninput="filtrarCompetencias()">
                            </div>
                            <div id="competencias-options">
                                <div class="no-competencias">
                                    Clique em "Carregar Competências" na sidebar para obter a lista.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Descrição do Cenário</label>
                <textarea class="form-textarea" id="descricao">Durante o combate, um dos elementos da equipa reporta via rádio que está desorientado e com o ar a terminar (alarme de baixa pressão ativo). O rádio tem má receção.</textarea>
            </div>

            <div class="options-section" id="options-container">
                <label class="form-label">Opções de Resposta</label>

                <div class="option-item">
                    <span class="option-number">1</span>
                    <div class="radio-btn" data-option="1"></div>
                    <input type="text" class="option-input" data-option="1" value="Ignorar a chamada até terminar a tarefa atual.">
                    <button class="btn-delete" onclick="deleteOption(1)">🗑️</button>
                </div>

                <div class="option-item">
                    <span class="option-number">2</span>
                    <div class="radio-btn checked" data-option="2"></div>
                    <input type="text" class="option-input correct" data-option="2" value="Declarar Mayday, ordenar evacuação imediata de todas as equipas e ativar">
                    <button class="btn-delete" onclick="deleteOption(2)">🗑️</button>
                </div>

                <div class="option-item">
                    <span class="option-number">3</span>
                    <div class="radio-btn" data-option="3"></div>
                    <input type="text" class="option-input" data-option="3" value="Tentar contactar o elemento repetidamente sem libertar o canal de rádio.">
                    <button class="btn-delete" onclick="deleteOption(3)">🗑️</button>
                </div>

                <div class="option-item">
                    <span class="option-number">4</span>
                    <div class="radio-btn" data-option="4"></div>
                    <input type="text" class="option-input" data-option="4" value="Enviar um estagiário à procura do elemento perdido.">
                    <button class="btn-delete" onclick="deleteOption(4)">🗑️</button>
                </div>

                <button class="btn-add-option">
                    + Adicionar Opção
                </button>
            </div>

            <div class="media-section">
                <label class="form-label">Recursos Multimédia (Opcional)</label>
                <p style="color: #7f8c8d; font-size: 13px; margin-bottom: 12px;">Adicione URLs de imagens ou vídeos alojados em serviços externos (YouTube, Vimeo, servidores próprios, etc.)</p>
                <div class="media-grid" id="media-grid">
                    <!-- Media items will be added here -->
                </div>
                <button class="btn-add-media" onclick="adicionarURLMedia()">
                    🔗 Adicionar URL de Recurso
                </button>
            </div>

            <div class="info-box">
                <span class="info-icon">ℹ️</span>
                <div>
                    Selecione o botão radial (radio button) à esquerda da opção para definir qual é a resposta correta para esta questão.
                </div>
            </div>
        </main>
    </div>

    <!-- Modal para adicionar URL -->
    <div class="modal" id="media-modal">
        <div class="modal-content">
            <div class="modal-header">Adicionar Recurso Multimédia</div>
            <div>
                <label class="form-label">Tipo de Recurso</label>
                <select class="media-type-select" id="media-type-select">
                    <option value="image">Imagem</option>
                    <option value="video">Vídeo (URL direta)</option>
                    <option value="youtube">YouTube</option>
                    <option value="vimeo">Vimeo</option>
                </select>
            </div>
            <div style="margin-top: 16px;">
                <label class="form-label">URL do Recurso</label>
                <input type="text" class="media-url-input" id="media-url-input" placeholder="https://exemplo.com/recurso.jpg">
                <p style="color: #95a5a6; font-size: 12px; margin-top: 4px;">
                    Cole o URL completo do recurso alojado externamente
                </p>
            </div>
            <div class="modal-buttons">
                <button class="btn-modal btn-cancel" onclick="fecharModalMedia()">Cancelar</button>
                <button class="btn-modal btn-confirm" onclick="confirmarURLMedia()">Adicionar</button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">A guardar alterações...</div>
        </div>
    </div>

    <script>
        let optionCount = 4;
        let correctOption = 2;
        let currentQuestionId = 2;
        let competenciasDisponiveis = [];
        let questionsData = {
            1: {
                competencias: [1, 2], // IDs das competências selecionadas
                descricao: "A equipa está a enfrentar um incêndio de grandes dimensões e os recursos disponíveis estão a esgotar-se rapidamente.",
                opcoes: [
                    { texto: "Continuar o combate até ao fim dos recursos", correta: false },
                    { texto: "Solicitar reforços imediatamente e reorganizar as equipas", correta: true },
                    { texto: "Abandonar a operação", correta: false }
                ],
                media: []
            },
            2: {
                competencias: [3], // IDs das competências selecionadas
                descricao: "Durante o combate, um dos elementos da equipa reporta via rádio que está desorientado e com o ar a terminar (alarme de baixa pressão ativo). O rádio tem má receção.",
                opcoes: [
                    { texto: "Ignorar a chamada até terminar a tarefa atual.", correta: false },
                    { texto: "Declarar Mayday, ordenar evacuação imediata de todas as equipas e ativar", correta: true },
                    { texto: "Tentar contactar o elemento repetidamente sem libertar o canal de rádio.", correta: false },
                    { texto: "Enviar um estagiário à procura do elemento perdido.", correta: false }
                ],
                media: []
            }
        };

        // Função auxiliar para garantir que a cor tem o formato correto
        function normalizarCor(cor) {
            if (!cor) return '#3498db';
            // Se não começar com #, adicionar
            return cor.startsWith('#') ? cor : '#' + cor;
        }

        // Inicializar eventos dos radio buttons
        function initRadioButtons() {
            document.querySelectorAll('.radio-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const optionId = this.getAttribute('data-option');

                    document.querySelectorAll('.radio-btn').forEach(b => b.classList.remove('checked'));
                    document.querySelectorAll('.option-input').forEach(input => {
                        input.classList.remove('correct');
                    });

                    this.classList.add('checked');
                    document.querySelector(`.option-input[data-option="${optionId}"]`).classList.add('correct');
                    correctOption = parseInt(optionId);
                });
            });
        }

        initRadioButtons();

        // Função para carregar competências da API
        async function carregarCompetencias() {
            const btn = document.getElementById('btn-load-competencias');
            const optionsDiv = document.getElementById('competencias-options');
            const apiUrl = document.getElementById('api-competencias-url').value.trim();

            if (!apiUrl) {
                alert('Por favor, configure o URL da API de Competências!');
                return;
            }

            btn.disabled = true;
            btn.textContent = '⏳ A carregar...';
            optionsDiv.innerHTML = '<div class="no-competencias">A carregar competências...</div>';

            try {
                const apiKey = document.getElementById('api-key').value.trim();
                const headers = {
                    'Content-Type': 'application/json'
                };

                if (apiKey) {
                    headers['Authorization'] = `Bearer ${apiKey}`;
                }

                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: headers
                });

                if (!response.ok) {
                    throw new Error(`Erro na API: ${response.status} - ${response.statusText}`);
                }

                const data = await response.json();

                // Assumir que a API retorna: { competencias: [{id: 1, descricao: "...", cor: "#ef34cd"}, ...] }
                competenciasDisponiveis = data.competencias || data;

                // Normalizar estrutura: aceitar tanto "nome" quanto "descricao"
                competenciasDisponiveis = competenciasDisponiveis.map(comp => ({
                    id: comp.id,
                    nome: comp.nome || comp.descricao,
                    descricao: comp.descricao || comp.nome,
                    cor: normalizarCor(comp.cor || comp.color)
                }));

                if (!Array.isArray(competenciasDisponiveis) || competenciasDisponiveis.length === 0) {
                    throw new Error('Nenhuma competência encontrada na resposta da API');
                }

                renderizarOpcoesCompetencias();
                renderizarTagsCompetencias();

                btn.textContent = '✅ Competências Carregadas';
                setTimeout(() => {
                    btn.disabled = false;
                    btn.textContent = '🔄 Recarregar Competências';
                }, 2000);

            } catch (error) {
                console.error('Erro ao carregar competências:', error);
                optionsDiv.innerHTML = `<div class="no-competencias" style="color: #e74c3c;">❌ ${error.message}<br><small>Clique em "Recarregar" para tentar novamente</small></div>`;
                btn.disabled = false;
                btn.textContent = '🔄 Recarregar Competências';

                // Criar dados de exemplo para teste
                console.log('Usando competências de exemplo para teste');
                competenciasDisponiveis = [
                    { id: 1, nome: "Gestão de Recursos e Equipamentos", descricao: "Gestão de Recursos e Equipamentos", cor: "#e74c3c" },
                    { id: 2, nome: "Planeamento e Organização", descricao: "Planeamento e Organização", cor: "#3498db" },
                    { id: 3, nome: "Liderança sob Pressão e Comunicações", descricao: "Liderança sob Pressão e Comunicações", cor: "#ef34cd" },
                    { id: 4, nome: "Tomada de Decisão em Situações Críticas", descricao: "Tomada de Decisão em Situações Críticas", cor: "#f39c12" },
                    { id: 5, nome: "Trabalho em Equipa", descricao: "Trabalho em Equipa", cor: "#9b59b6" },
                    { id: 6, nome: "Segurança e Gestão de Risco", descricao: "Segurança e Gestão de Risco", cor: "#1abc9c" },
                    { id: 7, nome: "Gestão de Stress e Controlo Emocional", descricao: "Gestão de Stress e Controlo Emocional", cor: "#e67e22" },
                    { id: 8, nome: "Comunicação Eficaz", descricao: "Comunicação Eficaz", cor: "#2ecc71" },
                    { id: 9, nome: "Resolução de Conflitos", descricao: "Resolução de Conflitos", cor: "#34495e" },
                    { id: 10, nome: "Adaptabilidade e Flexibilidade", descricao: "Adaptabilidade e Flexibilidade", cor: "#16a085" }
                ];
                renderizarOpcoesCompetencias();
                renderizarTagsCompetencias();
            }
        }

        // Toggle dropdown de competências
        function toggleCompetenciasDropdown() {
            const dropdown = document.getElementById('competencias-dropdown');
            dropdown.classList.toggle('active');

            if (dropdown.classList.contains('active')) {
                document.getElementById('competencias-search').focus();
            }
        }

        // Fechar dropdown ao clicar fora
        document.addEventListener('click', function(e) {
            const wrapper = document.querySelector('.competencias-wrapper');
            const dropdown = document.getElementById('competencias-dropdown');

            if (wrapper && !wrapper.contains(e.target)) {
                dropdown.classList.remove('active');
            }
        });

        // Renderizar opções no dropdown
        function renderizarOpcoesCompetencias(filtro = '') {
            const optionsDiv = document.getElementById('competencias-options');
            const question = questionsData[currentQuestionId];
            const competenciasSelecionadas = question.competencias || [];

            const competenciasFiltradas = competenciasDisponiveis.filter(comp =>
                comp.nome.toLowerCase().includes(filtro.toLowerCase())
            );

            if (competenciasFiltradas.length === 0) {
                optionsDiv.innerHTML = '<div class="no-competencias">Nenhuma competência encontrada</div>';
                return;
            }

            optionsDiv.innerHTML = '';

            competenciasFiltradas.forEach(comp => {
                const isSelected = competenciasSelecionadas.includes(comp.id);
                const cor = normalizarCor(comp.cor);

                const div = document.createElement('div');
                div.className = 'competencia-option' + (isSelected ? ' selected' : '');
                div.style.setProperty('--competencia-color', cor);
                div.onclick = () => toggleCompetencia(comp.id);

                div.innerHTML = `
                    <div class="competencia-option-check">${isSelected ? '✓' : ''}</div>
                    <div class="competencia-color-dot" style="background-color: ${cor}"></div>
                    <div class="competencia-option-info">
                        <div class="competencia-option-nome">${comp.nome}</div>
                        <div class="competencia-option-id">ID: ${comp.id}</div>
                    </div>
                `;

                optionsDiv.appendChild(div);
            });
        }

        // Toggle seleção de competência
        function toggleCompetencia(compId) {
            const question = questionsData[currentQuestionId];
            if (!question.competencias) {
                question.competencias = [];
            }

            const index = question.competencias.indexOf(compId);
            if (index > -1) {
                question.competencias.splice(index, 1);
            } else {
                question.competencias.push(compId);
            }

            renderizarOpcoesCompetencias(document.getElementById('competencias-search').value);
            renderizarTagsCompetencias();
        }

        // Renderizar tags selecionadas
        function renderizarTagsCompetencias() {
            const tagsDiv = document.getElementById('competencias-tags');
            const question = questionsData[currentQuestionId];
            const competenciasSelecionadas = question.competencias || [];

            tagsDiv.innerHTML = '';

            if (competenciasSelecionadas.length === 0) {
                tagsDiv.classList.add('empty');
                return;
            }

            tagsDiv.classList.remove('empty');

            competenciasSelecionadas.forEach(compId => {
                const comp = competenciasDisponiveis.find(c => c.id === compId);
                if (!comp) return;

                const cor = normalizarCor(comp.cor);

                const tag = document.createElement('div');
                tag.className = 'competencia-tag';
                tag.style.backgroundColor = cor;
                tag.innerHTML = `
                    <span>${comp.nome}</span>
                    <span class="competencia-tag-remove" onclick="event.stopPropagation(); removerCompetencia(${compId})">×</span>
                `;

                tagsDiv.appendChild(tag);
            });
        }

        // Remover competência
        function removerCompetencia(compId) {
            const question = questionsData[currentQuestionId];
            const index = question.competencias.indexOf(compId);
            if (index > -1) {
                question.competencias.splice(index, 1);
            }

            renderizarOpcoesCompetencias(document.getElementById('competencias-search').value);
            renderizarTagsCompetencias();
        }

        // Filtrar competências
        function filtrarCompetencias() {
            const filtro = document.getElementById('competencias-search').value;
            renderizarOpcoesCompetencias(filtro);
        }

        // Adicionar interatividade aos itens da lista de questões
        document.querySelectorAll('.question-item').forEach(item => {
            item.addEventListener('click', function() {
                document.querySelectorAll('.question-item').forEach(i => i.classList.remove('active'));
                this.classList.add('active');
            });
        });

        // Função para carregar uma questão
        function carregarQuestao(questionId) {
            // Salvar questão atual antes de trocar
            salvarQuestaoAtual();

            currentQuestionId = questionId;
            const question = questionsData[questionId];

            if (!question) return;

            // Atualizar interface
            document.getElementById('current-question-number').textContent = questionId;
            document.getElementById('descricao').value = question.descricao;

            // Atualizar competências se já foram carregadas
            if (competenciasDisponiveis.length > 0) {
                renderizarTagsCompetencias();
                renderizarOpcoesCompetencias();
            }

            // Limpar e recriar opções
            const container = document.getElementById('options-container');
            const label = container.querySelector('.form-label');
            const btnAdd = container.querySelector('.btn-add-option');

            // Remove todas as opções existentes
            container.querySelectorAll('.option-item').forEach(item => item.remove());

            // Adiciona as novas opções
            question.opcoes.forEach((opcao, index) => {
                const optionNum = index + 1;
                const newOption = document.createElement('div');
                newOption.className = 'option-item';
                newOption.innerHTML = `
                    <span class="option-number">${optionNum}</span>
                    <div class="radio-btn ${opcao.correta ? 'checked' : ''}" data-option="${optionNum}"></div>
                    <input type="text" class="option-input ${opcao.correta ? 'correct' : ''}" data-option="${optionNum}" value="${opcao.texto}">
                    <button class="btn-delete" onclick="deleteOption(${optionNum})">🗑️</button>
                `;
                container.insertBefore(newOption, btnAdd);
            });

            optionCount = question.opcoes.length;
            correctOption = question.opcoes.findIndex(o => o.correta) + 1;

            // Carregar media
            carregarMedia(question.media || []);

            // Reinicializar eventos
            initRadioButtons();

            // Atualizar lista de questões na sidebar
            document.querySelectorAll('.question-item').forEach(item => {
                item.classList.remove('active');
                if (parseInt(item.getAttribute('data-question')) === questionId) {
                    item.classList.add('active');
                }
            });
        }

        // Função para salvar questão atual
        function salvarQuestaoAtual() {
            const descricao = document.getElementById('descricao').value;
            const opcoes = [];

            document.querySelectorAll('.option-item').forEach(item => {
                const input = item.querySelector('.option-input');
                const radio = item.querySelector('.radio-btn');
                opcoes.push({
                    texto: input.value,
                    correta: radio.classList.contains('checked')
                });
            });

            questionsData[currentQuestionId] = {
                competencias: questionsData[currentQuestionId].competencias || [],
                descricao,
                opcoes,
                media: questionsData[currentQuestionId].media || []
            };
        }

        // Função para adicionar nova questão
        function adicionarQuestao() {
            // Salvar questão atual
            salvarQuestaoAtual();

            // Criar nova questão
            const newQuestionId = Object.keys(questionsData).length + 1;
            questionsData[newQuestionId] = {
                competencias: [],
                descricao: "Descrição do cenário...",
                opcoes: [
                    { texto: "Opção 1", correta: true },
                    { texto: "Opção 2", correta: false }
                ],
                media: []
            };

            // Adicionar à lista na sidebar
            const questionList = document.getElementById('question-list');
            const newItem = document.createElement('li');
            newItem.className = 'question-item';
            newItem.setAttribute('data-question', newQuestionId);
            newItem.setAttribute('onclick', `carregarQuestao(${newQuestionId})`);
            newItem.innerHTML = `
                <span class="question-number">${newQuestionId}</span>
                Nova Questão
            `;
            questionList.appendChild(newItem);

            // Atualizar contador
            document.getElementById('question-count').textContent = Object.keys(questionsData).length;

            // Carregar a nova questão
            carregarQuestao(newQuestionId);
        }

        // Gerenciamento de Media
        function carregarMedia(mediaArray) {
            const mediaGrid = document.getElementById('media-grid');
            mediaGrid.innerHTML = '';

            if (!mediaArray || mediaArray.length === 0) {
                return;
            }

            mediaArray.forEach((media, index) => {
                const mediaItem = document.createElement('div');
                mediaItem.className = 'media-item';

                let content = '';

                if (media.type === 'image') {
                    content = `
                        <div class="media-item-content">
                            <img src="${media.url}" alt="Imagem ${index + 1}" onerror="this.parentElement.innerHTML='<div class=\\'media-error\\'>Erro ao carregar imagem</div>'">
                        </div>
                        <button class="media-delete" onclick="deleteMedia(${index})">🗑️</button>
                        <span class="media-type-badge">Imagem</span>
                    `;
                } else if (media.type === 'video') {
                    content = `
                        <div class="media-item-content">
                            <video src="${media.url}" controls onerror="this.parentElement.innerHTML='<div class=\\'media-error\\'>Erro ao carregar vídeo</div>'"></video>
                        </div>
                        <button class="media-delete" onclick="deleteMedia(${index})">🗑️</button>
                        <span class="media-type-badge">Vídeo</span>
                    `;
                } else if (media.type === 'youtube') {
                    const videoId = extrairYouTubeId(media.url);
                    content = `
                        <div class="media-item-content">
                            <iframe src="https://www.youtube.com/embed/${videoId}" allowfullscreen></iframe>
                        </div>
                        <button class="media-delete" onclick="deleteMedia(${index})">🗑️</button>
                        <span class="media-type-badge">YouTube</span>
                    `;
                } else if (media.type === 'vimeo') {
                    const videoId = extrairVimeoId(media.url);
                    content = `
                        <div class="media-item-content">
                            <iframe src="https://player.vimeo.com/video/${videoId}" allowfullscreen></iframe>
                        </div>
                        <button class="media-delete" onclick="deleteMedia(${index})">🗑️</button>
                        <span class="media-type-badge">Vimeo</span>
                    `;
                }

                mediaItem.innerHTML = content;
                mediaGrid.appendChild(mediaItem);
            });
        }

        // Extrair ID do YouTube
        function extrairYouTubeId(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        // Extrair ID do Vimeo
        function extrairVimeoId(url) {
            const regExp = /vimeo.*\/(\d+)/i;
            const match = url.match(regExp);
            return match ? match[1] : null;
        }

        // Abrir modal para adicionar URL
        function adicionarURLMedia() {
            document.getElementById('media-modal').classList.add('active');
            document.getElementById('media-url-input').value = '';
            document.getElementById('media-type-select').value = 'image';
            document.getElementById('media-url-input').focus();
        }

        // Fechar modal
        function fecharModalMedia() {
            document.getElementById('media-modal').classList.remove('active');
        }

        // Confirmar e adicionar URL
        function confirmarURLMedia() {
            const url = document.getElementById('media-url-input').value.trim();
            const type = document.getElementById('media-type-select').value;

            if (!url) {
                alert('Por favor, insira um URL válido!');
                return;
            }

            // Validação básica de URL
            try {
                new URL(url);
            } catch (e) {
                alert('URL inválido! Certifique-se de incluir http:// ou https://');
                return;
            }

            // Validação específica para YouTube e Vimeo
            if (type === 'youtube' && !url.includes('youtube.com') && !url.includes('youtu.be')) {
                alert('Por favor, insira um URL válido do YouTube!');
                return;
            }

            if (type === 'vimeo' && !url.includes('vimeo.com')) {
                alert('Por favor, insira um URL válido do Vimeo!');
                return;
            }

            // Adicionar ao array de media da questão atual
            if (!questionsData[currentQuestionId].media) {
                questionsData[currentQuestionId].media = [];
            }

            questionsData[currentQuestionId].media.push({
                type: type,
                url: url
            });

            // Recarregar media
            carregarMedia(questionsData[currentQuestionId].media);

            // Fechar modal
            fecharModalMedia();
        }

        // Fechar modal ao clicar fora
        document.getElementById('media-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                fecharModalMedia();
            }
        });

        // Adicionar suporte para Enter no input
        document.getElementById('media-url-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                confirmarURLMedia();
            }
        });

        // Fechar modal com ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('media-modal');
                if (modal.classList.contains('active')) {
                    fecharModalMedia();
                }
            }
        });

        // Função para deletar media por índice
        function deleteMedia(index) {
            const question = questionsData[currentQuestionId];
            if (question && question.media) {
                question.media.splice(index, 1);
                carregarMedia(question.media);
            }
        }

        // Função para adicionar nova opção
        document.querySelector('.btn-add-option').addEventListener('click', function() {
            optionCount++;
            const optionsContainer = document.getElementById('options-container');
            const newOption = document.createElement('div');
            newOption.className = 'option-item';
            newOption.innerHTML = `
                <span class="option-number">${optionCount}</span>
                <div class="radio-btn" data-option="${optionCount}"></div>
                <input type="text" class="option-input" data-option="${optionCount}" placeholder="Digite a opção de resposta...">
                <button class="btn-delete" onclick="deleteOption(${optionCount})">🗑️</button>
            `;

            optionsContainer.insertBefore(newOption, this);

            const newRadio = newOption.querySelector('.radio-btn');
            newRadio.addEventListener('click', function() {
                const optionId = this.getAttribute('data-option');

                document.querySelectorAll('.radio-btn').forEach(b => b.classList.remove('checked'));
                document.querySelectorAll('.option-input').forEach(input => {
                    input.classList.remove('correct');
                });

                this.classList.add('checked');
                document.querySelector(`.option-input[data-option="${optionId}"]`).classList.add('correct');
                correctOption = parseInt(optionId);
            });
        });

        // Função para deletar opção
        function deleteOption(optionId) {
            const options = document.querySelectorAll('.option-item');
            if (options.length <= 2) {
                alert('É necessário ter pelo menos 2 opções de resposta!');
                return;
            }

            const optionToDelete = document.querySelector(`.option-item .radio-btn[data-option="${optionId}"]`).closest('.option-item');
            optionToDelete.remove();

            const remainingOptions = document.querySelectorAll('.option-item');
            remainingOptions.forEach((option, index) => {
                const number = index + 1;
                option.querySelector('.option-number').textContent = number;
                option.querySelector('.radio-btn').setAttribute('data-option', number);
                option.querySelector('.option-input').setAttribute('data-option', number);
            });

            optionCount = remainingOptions.length;
        }

        // Função para salvar tudo
        document.querySelector('.btn-save').addEventListener('click', async function() {
            salvarQuestaoAtual();

            // Preparar dados para envio à API
            const payload = prepararDadosParaAPI();

            // Mostrar loading
            document.getElementById('loading-overlay').classList.add('active');

            try {
                const apiUrl = document.getElementById('api-url').value.trim();
                const apiKey = document.getElementById('api-key').value.trim();

                if (!apiUrl) {
                    throw new Error('Por favor, configure o URL da API!');
                }

                // Preparar headers
                const headers = {
                    'Content-Type': 'application/json'
                };

                if (apiKey) {
                    headers['Authorization'] = `Bearer ${apiKey}`;
                }

                // Fazer requisição à API
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(payload)
                });

                // Esconder loading
                document.getElementById('loading-overlay').classList.remove('active');

                if (!response.ok) {
                    throw new Error(`Erro na API: ${response.status} - ${response.statusText}`);
                }

                const result = await response.json();

                console.log('Resposta da API:', result);
                alert('✅ Alterações guardadas com sucesso!\n\nTotal de questões: ' + Object.keys(questionsData).length);

            } catch (error) {
                // Esconder loading
                document.getElementById('loading-overlay').classList.remove('active');

                console.error('Erro ao guardar:', error);
                alert('❌ Erro ao guardar alterações:\n\n' + error.message + '\n\nVerifique o console para mais detalhes.');

                // Mostrar dados no console para debug
                console.log('Dados que seriam enviados:', payload);
            }
        });

        // Função para preparar dados no formato correto para a API
        function prepararDadosParaAPI() {
            const questoes = [];

            Object.keys(questionsData).forEach(questionId => {
                const q = questionsData[questionId];

                // Encontrar o índice da resposta correta
                const respostaCorretaIndex = q.opcoes.findIndex(opcao => opcao.correta);

                // Obter informações completas das competências selecionadas
                const competenciasInfo = q.competencias.map(compId => {
                    const comp = competenciasDisponiveis.find(c => c.id === compId);
                    return comp ? {
                        id: comp.id,
                        descricao: comp.descricao || comp.nome,
                        cor: comp.cor
                    } : null;
                }).filter(Boolean);

                const questao = {
                    id: parseInt(questionId),
                    competencias: competenciasInfo,
                    descricao: q.descricao,
                    opcoes: q.opcoes.map((opcao, index) => ({
                        id: index + 1,
                        texto: opcao.texto,
                        correta: opcao.correta
                    })),
                    respostaCorreta: respostaCorretaIndex + 1, // Índice baseado em 1
                };

                // Adicionar recursos multimédia se existirem
                if (q.media && q.media.length > 0) {
                    questao.recursosMultimedia = q.media.map((media, index) => ({
                        id: index + 1,
                        tipo: media.type,
                        url: media.url
                    }));
                }

                questoes.push(questao);
            });

            return {
                cenario: document.querySelector('.sidebar-input').value || "Chefe de Grupo",
                totalQuestoes: questoes.length,
                questoes: questoes,
                dataEnvio: new Date().toISOString()
            };
        }
    </script>
</body>
</html>