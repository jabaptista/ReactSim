<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuração do Cenário (ReactSim)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
        }

        .header {
            background: #2c3e50;
            color: white;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-title h1 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .header-subtitle {
            font-size: 13px;
            color: #bdc3c7;
        }

        .btn-save {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

            .btn-save:hover {
                background: #c0392b;
            }

        .container {
            display: flex;
            height: calc(100vh - 80px);
        }

        .sidebar {
            width: 240px;
            background: white;
            border-right: 1px solid #e0e0e0;
            padding: 20px;
            overflow-y: auto;
        }

        .sidebar-section {
            margin-bottom: 24px;
        }

        .sidebar-title {
            font-size: 11px;
            font-weight: 700;
            color: #95a5a6;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .sidebar-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .question-list {
            list-style: none;
        }

        .question-item {
            padding: 10px 12px;
            margin-bottom: 4px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            color: #555;
            transition: background 0.2s;
        }

            .question-item:hover {
                background: #f8f9fa;
            }

            .question-item.active {
                background: #fee;
                color: #e74c3c;
                border-left: 3px solid #e74c3c;
                padding-left: 9px;
            }

        .question-number {
            display: inline-block;
            width: 20px;
            font-weight: 600;
        }

        .btn-add {
            width: 100%;
            padding: 10px;
            border: 1px dashed #bdc3c7;
            background: white;
            border-radius: 4px;
            color: #7f8c8d;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

            .btn-add:hover {
                border-color: #95a5a6;
                color: #555;
            }

        .main-content {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 32px;
        }

        .section-number {
            background: #e74c3c;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
        }

        .section-header h2 {
            font-size: 24px;
            color: #2c3e50;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e74c3c;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }

        .form-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            min-height: 100px;
            font-family: inherit;
            resize: vertical;
            background: white;
            color: #2c3e50;
        }

            .form-textarea:focus {
                outline: none;
                border-color: #3498db;
            }

        .options-section {
            margin-top: 32px;
        }

        .option-item {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .option-number {
            font-size: 12px;
            color: #95a5a6;
            width: 20px;
        }

        .radio-btn {
            width: 20px;
            height: 20px;
            border: 2px solid #bdc3c7;
            border-radius: 50%;
            cursor: pointer;
            flex-shrink: 0;
            position: relative;
        }

            .radio-btn.checked {
                border-color: #e74c3c;
            }

                .radio-btn.checked::after {
                    content: '';
                    position: absolute;
                    width: 10px;
                    height: 10px;
                    background: #e74c3c;
                    border-radius: 50%;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                }

        .option-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            color: #2c3e50;
        }

            .option-input:focus {
                outline: none;
                border-color: #3498db;
            }

            .option-input.correct {
                background: #e8f8f5;
                border-color: #27ae60;
            }

        .btn-delete {
            padding: 8px 12px;
            background: transparent;
            border: none;
            color: #95a5a6;
            cursor: pointer;
            border-radius: 4px;
        }

            .btn-delete:hover {
                background: #f8f9fa;
                color: #e74c3c;
            }

        .btn-add-option {
            background: transparent;
            border: none;
            color: #3498db;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            padding: 8px 0;
            display: flex;
            align-items: center;
            gap: 6px;
        }

            .btn-add-option:hover {
                color: #2980b9;
            }

        .info-box {
            background: #e8f4fd;
            border: 1px solid #b8dff5;
            border-radius: 6px;
            padding: 16px;
            margin-top: 24px;
            display: flex;
            gap: 12px;
            color: #2c3e50;
            font-size: 14px;
            line-height: 1.5;
        }

        .info-icon {
            color: #3498db;
            flex-shrink: 0;
        }

        .settings-icon {
            font-size: 24px;
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

            .loading-overlay.active {
                display: flex;
            }

        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 12px;
            text-align: center;
            max-width: 400px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #ecf0f1;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            color: #2c3e50;
            font-size: 16px;
            font-weight: 600;
        }

        .api-config {
            margin-bottom: 16px;
        }

        .api-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            margin-top: 4px;
        }

        .api-label {
            font-size: 11px;
            font-weight: 600;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .competencies-container {
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 12px;
            background: white;
            min-height: 120px;
        }

        .competencies-selected-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            min-height: 40px;
            padding: 8px;
            border: 2px dashed #ddd;
            border-radius: 6px;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.2s;
        }

            .competencies-selected-tags:hover {
                border-color: #3498db;
                background: #f0f8ff;
            }

            .competencies-selected-tags.empty::before {
                content: 'Clique para selecionar competências...';
                color: #95a5a6;
                font-size: 14px;
            }

        .competency-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            color: white;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

            .competency-tag:hover {
                filter: brightness(0.9);
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            }

        .competency-tag-remove {
            cursor: pointer;
            font-weight: bold;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

            .competency-tag-remove:hover {
                opacity: 1;
            }

        .competencies-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 4px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            max-height: 300px;
            overflow-y: auto;
            z-index: 100;
        }

            .competencies-dropdown.active {
                display: block;
            }

        .competency-option {
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
        }

            .competency-option::before {
                content: '';
                position: absolute;
                left: 0;
                top: 0;
                bottom: 0;
                width: 4px;
                background: transparent;
                transition: background 0.2s;
            }

            .competency-option:last-child {
                border-bottom: none;
            }

            .competency-option:hover {
                background: #f8f9fa;
            }

            .competency-option.selected {
                background: #f8f9fa;
                font-weight: 500;
            }

                .competency-option.selected::before {
                    background: var(--competency-color, #3498db);
                }

        .competency-option-check {
            width: 20px;
            height: 20px;
            border: 2px solid #ddd;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.2s;
        }

        .competency-option.selected .competency-option-check {
            background: var(--competency-color, #3498db);
            border-color: var(--competency-color, #3498db);
            color: white;
        }

        .competency-option-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .competency-option-nome {
            font-size: 14px;
            color: #2c3e50;
        }

        .competency-option-id {
            font-size: 11px;
            color: #95a5a6;
            font-weight: 500;
        }

        .competency-color-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .competencies-wrapper {
            position: relative;
        }

        .competencies-search {
            padding: 12px 16px;
            border-bottom: 2px solid #f0f0f0;
            background: #fafafa;
        }

            .competencies-search input {
                width: 100%;
                padding: 8px 12px;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 14px;
            }

                .competencies-search input:focus {
                    outline: none;
                    border-color: #3498db;
                }

        .no-competencies {
            padding: 20px;
            text-align: center;
            color: #95a5a6;
            font-size: 14px;
        }

        .btn-load-competencies {
            margin-top: 8px;
            padding: 8px 12px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            width: 100%;
            font-weight: 600;
        }

            .btn-load-competencies:hover {
                background: #2980b9;
            }

            .btn-load-competencies:disabled {
                background: #bdc3c7;
                cursor: not-allowed;
            }

        .competencies-loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
            font-size: 13px;
        }

        .competencies-error {
            text-align: center;
            padding: 20px;
            color: #e74c3c;
            font-size: 13px;
        }

        .media-section {
            margin-top: 32px;
            padding-top: 32px;
            border-top: 1px solid #e0e0e0;
        }

        .media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .media-item {
            position: relative;
            border: 2px dashed #ddd;
            border-radius: 8px;
            overflow: hidden;
            aspect-ratio: 16/9;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
        }

            .media-item img, .media-item video {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

        .media-item-empty {
            cursor: pointer;
            transition: all 0.3s;
        }

            .media-item-empty:hover {
                border-color: #3498db;
                background: #f0f8ff;
            }

        .media-upload-icon {
            font-size: 48px;
            color: #bdc3c7;
        }

        .media-delete {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(231, 76, 60, 0.9);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .media-item:hover .media-delete {
            opacity: 1;
        }

        .media-delete:hover {
            background: rgba(192, 57, 43, 1);
        }

        .media-type-badge {
            position: absolute;
            bottom: 8px;
            left: 8px;
            background: rgba(52, 152, 219, 0.9);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .btn-add-media {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: white;
            border: 2px dashed #3498db;
            border-radius: 6px;
            color: #3498db;
            font-weight: 600;
            cursor: pointer;
            margin-top: 16px;
            transition: all 0.2s;
        }

            .btn-add-media:hover {
                background: #f0f8ff;
                border-color: #2980b9;
            }

        .file-input-hidden {
            display: none;
        }

        .media-url-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 8px;
        }

            .media-url-input:focus {
                outline: none;
                border-color: #3498db;
            }

        .media-type-select {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            margin-right: 8px;
            cursor: pointer;
        }

            .media-type-select:focus {
                outline: none;
                border-color: #3498db;
            }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

            .modal.active {
                display: flex;
            }

        .modal-content {
            background: white;
            padding: 32px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            font-size: 20px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn-modal {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-cancel {
            background: #ecf0f1;
            color: #7f8c8d;
        }

            .btn-cancel:hover {
                background: #bdc3c7;
            }

        .btn-confirm {
            background: #3498db;
            color: white;
        }

            .btn-confirm:hover {
                background: #2980b9;
            }

        .media-item-content {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

            .media-item-content iframe {
                width: 100%;
                height: 100%;
                border: none;
            }

        .media-error {
            color: #e74c3c;
            font-size: 12px;
            text-align: center;
            padding: 8px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <span class="settings-icon">⚙️</span>
            <div class="header-title">
                <h1>Configuração do Cenário (ReactSim)</h1>
                <div class="header-subtitle">Editor de Questões Múltiplas</div>
            </div>
        </div>
        <button class="btn-save">
            💾 Guardar Alterações
        </button>
    </div>

    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title">Categoria Alvo</div>
                <input type="text" class="sidebar-input" value="Chefe de Grupo" placeholder="Nome do grupo">
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Questões (<span id="question-count">2</span>)</div>
                <ul class="question-list" id="question-list">
                    <li class="question-item" data-question="1" onclick="loadQuestion(1)">
                        <span class="question-number">1</span>
                        Gestão de Recursos e ...
                    </li>
                    <li class="question-item active" data-question="2" onclick="loadQuestion(2)">
                        <span class="question-number">2</span>
                        Liderança sob Pressã...
                    </li>
                </ul>
                <button class="btn-add" onclick="addQuestion()">
                    + Adicionar Questão
                </button>
            </div>
        </aside>

        <main class="main-content">
            <div class="section-header">
                <div class="section-number" id="current-question-number">2</div>
                <h2>Editar Questão</h2>
            </div>

            <div class="form-group">
                <label class="form-label">Competências a Avaliar</label>
                <div class="competencies-wrapper">
                    <div class="competencies-container">
                        <div class="competencies-selected-tags empty" id="competencies-tags" onclick="toggleCompetenciesDropdown()">
                            <!-- Tags serão adicionadas aqui -->
                        </div>
                        <div class="competencies-dropdown" id="competencies-dropdown">
                            <div class="competencies-search">
                                <input type="text" placeholder="🔍 Pesquisar competências..." id="competencies-search" oninput="filterCompetencies()">
                            </div>
                            <div id="competencies-options">
                                <div class="no-competencies">
                                    Clique em "Carregar Competências" na sidebar para obter a lista.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Descrição do Cenário</label>
                <textarea class="form-textarea" id="description">Durante o combate, um dos elementos da equipa reporta via rádio que está desorientado e com o ar a terminar (alarme de baixa pressão ativo). O rádio tem má receção.</textarea>
            </div>

            <div class="options-section" id="options-container">
                <label class="form-label">Opções de Resposta</label>

                <div class="option-item">
                    <span class="option-number">1</span>
                    <div class="radio-btn" data-option="1"></div>
                    <input type="text" class="option-input" data-option="1" value="Ignorar a chamada até terminar a tarefa atual.">
                    <button class="btn-delete" onclick="deleteOption(1)">🗑️</button>
                </div>

                <div class="option-item">
                    <span class="option-number">2</span>
                    <div class="radio-btn checked" data-option="2"></div>
                    <input type="text" class="option-input correct" data-option="2" value="Declarar Mayday, ordenar evacuação imediata de todas as equipas e ativar">
                    <button class="btn-delete" onclick="deleteOption(2)">🗑️</button>
                </div>

                <div class="option-item">
                    <span class="option-number">3</span>
                    <div class="radio-btn" data-option="3"></div>
                    <input type="text" class="option-input" data-option="3" value="Tentar contactar o elemento repetidamente sem libertar o canal de rádio.">
                    <button class="btn-delete" onclick="deleteOption(3)">🗑️</button>
                </div>

                <div class="option-item">
                    <span class="option-number">4</span>
                    <div class="radio-btn" data-option="4"></div>
                    <input type="text" class="option-input" data-option="4" value="Enviar um estagiário à procura do elemento perdido.">
                    <button class="btn-delete" onclick="deleteOption(4)">🗑️</button>
                </div>

                <button class="btn-add-option">
                    + Adicionar Opção
                </button>
            </div>

            <div class="media-section">
                <label class="form-label">Recursos Multimédia (Opcional)</label>
                <p style="color: #7f8c8d; font-size: 13px; margin-bottom: 12px;">Adicione URLs de imagens ou vídeos alojados em serviços externos (YouTube, Vimeo, servidores próprios, etc.)</p>
                <div class="media-grid" id="media-grid">
                    <!-- Media items will be added here -->
                </div>
                <button class="btn-add-media" onclick="addMediaURL()">
                    🔗 Adicionar URL de Recurso
                </button>
            </div>

            <div class="info-box">
                <span class="info-icon">ℹ️</span>
                <div>
                    Selecione o botão radial (radio button) à esquerda da opção para definir qual é a resposta correta para esta questão.
                </div>
            </div>
        </main>
    </div>

    <!-- Modal para adicionar URL -->
    <div class="modal" id="media-modal">
        <div class="modal-content">
            <div class="modal-header">Adicionar Recurso Multimédia</div>
            <div>
                <label class="form-label">Tipo de Recurso</label>
                <select class="media-type-select" id="media-type-select">
                    <option value="image">Imagem</option>
                    <option value="video">Vídeo</option>
                    <option value="video">Object</option>
                </select>
            </div>
            <div style="margin-top: 16px;">
                <label class="form-label">URL do Recurso</label>
                <input type="text" class="media-url-input" id="media-url-input" placeholder="https://exemplo.com/recurso.jpg">
                <p style="color: #95a5a6; font-size: 12px; margin-top: 4px;">
                    Cole o URL completo do recurso alojado externamente
                </p>
            </div>
            <div style="margin-top: 16px;">
                <label class="form-label">Legenda do Recurso</label>
                <input type="text" class="media-url-input" id="media-caption-input" placeholder="Legenda do recurso">
                <p style="color: #95a5a6; font-size: 12px; margin-top: 4px;">
                    Insira uma legenda para o recurso.
                </p>
            </div>
            <div class="modal-buttons">
                <button class="btn-modal btn-cancel" onclick="closeMediaModal ()">Cancelar</button>
                <button class="btn-modal btn-confirm" onclick="confirmMediaURL()">Adicionar</button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">A guardar alterações...</div>
        </div>
    </div>

    <script src="/env.js"></script>

    <script>

        const API_BASE = (window.__env__ && window.__env__.API_URL)
            ? String(window.__env__.API_URL).replace(/\/$/, '')
            : 'http://localhost:32769';

        let optionCount = 4;
        let correctOption = 2;
        let currentQuestionId = 2;
        let availableCompetencies = [];
        let questionsData = {
            1: {
                competencies: [1, 2], // IDs das competências selecionadas
                description: "A equipa está a enfrentar um incêndio de grandes dimensões e os recursos disponíveis estão a esgotar-se rapidamente.",
                options: [
                    { text: "Continuar o combate até ao fim dos recursos", right: false },
                    { text: "Solicitar reforços imediatamente e reorganizar as equipas", right: true },
                    { text: "Abandonar a operação", right: false }
                ],
                media: []
            },
            2: {
                competencies: [3], // IDs das competências selecionadas
                description: "Durante o combate, um dos elementos da equipa reporta via rádio que está desorientado e com o ar a terminar (alarme de baixa pressão ativo). O rádio tem má receção.",
                options: [
                    { text: "Ignorar a chamada até terminar a tarefa atual.", right: false },
                    { text: "Declarar Mayday, ordenar evacuação imediata de todas as equipas e ativar", right: true },
                    { text: "Tentar contactar o elemento repetidamente sem libertar o canal de rádio.", right: false },
                    { text: "Enviar um estagiário à procura do elemento perdido.", right: false }
                ],
                media: []
            }
        };

        async function initialize() {
            loadCompetencies();
        } 

        // Função auxiliar para garantir que a cor tem o formato correto
        function normalizeColor(color) {
            if (!color) return '#3498db';
            // Se não começar com #, adicionar
            return color.startsWith('#') ? color : '#' + color;
        }

        // Inicializar eventos dos radio buttons
        function initRadioButtons() {
            document.querySelectorAll('.radio-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const optionId = this.getAttribute('data-option');

                    document.querySelectorAll('.radio-btn').forEach(b => b.classList.remove('checked'));
                    document.querySelectorAll('.option-input').forEach(input => {
                        input.classList.remove('correct');
                    });

                    this.classList.add('checked');
                    document.querySelector(`.option-input[data-option="${optionId}"]`).classList.add('correct');
                    correctOption = parseInt(optionId);
                });
            });
        }

        initRadioButtons();

        // Função para carregar competências da API
        async function loadCompetencies() {
            const optionsDiv = document.getElementById('competencies-options');
            const apiUrl = API_BASE + '/api/competency/';

            if (!apiUrl) {
                alert('Por favor, configure o URL da API de Competências!');
                return;
            }
            
            optionsDiv.innerHTML = '<div class="no-competencies">A carregar competências...</div>';

            try {
                const headers = {
                    'Content-Type': 'application/json'
                };

                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: headers
                });

                if (!response.ok) {
                    throw new Error(`Erro na API: ${response.status} - ${response.statusText}`);
                }

                const data = await response.json();

                // Assumir que a API retorna: { competencies: [{id: 1, description: "...", cor: "#ef34cd"}, ...] }
                availableCompetencies = data.competencies || data;

                // Normalizar estrutura: aceitar tanto "nome" quanto "description"
                availableCompetencies = availableCompetencies.map(comp => ({
                    id: comp.id,
                    name: comp.name,
                    description: comp.description,
                    color: normalizeColor(comp.color)
                }));

                if (!Array.isArray(availableCompetencies) || availableCompetencies.length === 0) {
                    throw new Error('Nenhuma competência encontrada na resposta da API');
                }

                renderCompetenciesOptions();
                renderCompetenciesTags();

            } catch (error) {
                console.error('Erro ao carregar competências:', error);
                optionsDiv.innerHTML = `<div class="no-competencies" style="color: #e74c3c;">❌ ${error.message}<br><small>Clique em "Recarregar" para tentar novamente</small></div>`;
                btn.disabled = false;
                btn.textContent = '🔄 Recarregar Competências';

                renderCompetenciesOptions();
                renderCompetenciesTags();
            }
        }

        // Toggle dropdown de competências
        function toggleCompetenciesDropdown() {
            const dropdown = document.getElementById('competencies-dropdown');
            dropdown.classList.toggle('active');

            if (dropdown.classList.contains('active')) {
                document.getElementById('competencies-search').focus();
            }
        }

        // Fechar dropdown ao clicar fora
        document.addEventListener('click', function (e) {
            const wrapper = document.querySelector('.competencies-wrapper');
            const dropdown = document.getElementById('competencies-dropdown');

            if (wrapper && !wrapper.contains(e.target)) {
                dropdown.classList.remove('active');
            }
        });

        // Renderizar opções no dropdown
        function renderCompetenciesOptions(filtro = '') {
            const optionsDiv = document.getElementById('competencies-options');
            const question = questionsData[currentQuestionId];
            const selectedCompetencies = question.competencies || [];

            const filteredCompetencies = availableCompetencies.filter(comp =>
                comp.name.toLowerCase().includes(filtro.toLowerCase())
            );

            if (filteredCompetencies.length === 0) {
                optionsDiv.innerHTML = '<div class="no-competencies">Nenhuma competência encontrada</div>';
                return;
            }

            optionsDiv.innerHTML = '';

            filteredCompetencies.forEach(comp => {
                const isSelected = selectedCompetencies.includes(comp.id);
                const color = normalizeColor(comp.color);

                const div = document.createElement('div');
                div.className = 'competency-option' + (isSelected ? ' selected' : '');
                div.style.setProperty('--competency-color', color);
                div.onclick = () => toggleCompetency(comp.id);

                div.innerHTML = `
                        <div class="competency-option-check">${isSelected ? '✓' : ''}</div>
                        <div class="competency-color-dot" style="background-color: ${color}"></div>
                        <div class="competency-option-info">
                            <div class="competency-option-name">${comp.name}</div>
                            <div class="competency-option-id">ID: ${comp.id}</div>
                        </div>
                    `;

                optionsDiv.appendChild(div);
            });
        }

        // Toggle seleção de competência
        function toggleCompetency(compId) {
            const question = questionsData[currentQuestionId];
            if (!question.competencies) {
                question.competencies = [];
            }

            const index = question.competencies.indexOf(compId);
            if (index > -1) {
                question.competencies.splice(index, 1);
            } else {
                question.competencies.push(compId);
            }

            renderCompetenciesOptions(document.getElementById('competencies-search').value);
            renderCompetenciesTags();
        }

        // Renderizar tags selecionadas
        function renderCompetenciesTags() {
            const tagsDiv = document.getElementById('competencies-tags');
            const question = questionsData[currentQuestionId];
            const selectedCompetencies = question.competencies || [];

            tagsDiv.innerHTML = '';

            if (selectedCompetencies.length === 0) {
                tagsDiv.classList.add('empty');
                return;
            }

            tagsDiv.classList.remove('empty');

            selectedCompetencies.forEach(compId => {
                const comp = availableCompetencies.find(c => c.id === compId);
                if (!comp) return;

                const color = normalizeColor(comp.color);

                const tag = document.createElement('div');
                tag.className = 'competency-tag';
                tag.style.backgroundColor = color;
                tag.innerHTML = `
                        <span>${comp.name}</span>
                        <span class="competency-tag-remove" onclick="event.stopPropagation(); removerCompetency(${compId})">×</span>
                    `;

                tagsDiv.appendChild(tag);
            });
        }

        // Remover competência
        function removeCompetency(compId) {
            const question = questionsData[currentQuestionId];
            const index = question.competencies.indexOf(compId);
            if (index > -1) {
                question.competencies.splice(index, 1);
            }

            renderCompetenciesOptions(document.getElementById('competencies-search').value);
            renderCompetenciesTags();
        }

        // Filtrar competências
        function filterCompetencies() {
            const filtro = document.getElementById('competencies-search').value;
            renderCompetenciesOptions(filtro);
        }

        // Adicionar interatividade aos itens da lista de questões
        document.querySelectorAll('.question-item').forEach(item => {
            item.addEventListener('click', function () {
                document.querySelectorAll('.question-item').forEach(i => i.classList.remove('active'));
                this.classList.add('active');
            });
        });

        // Função para carregar uma questão
        function loadQuestion(questionId) {
            // Salvar questão atual antes de trocar
            saveActualQuestion();

            currentQuestionId = questionId;
            const question = questionsData[questionId];

            if (!question) return;

            // Atualizar interface
            document.getElementById('current-question-number').textContent = questionId;
            document.getElementById('description').value = question.description;

            // Atualizar competências se já foram carregadas
            if (availableCompetencies.length > 0) {
                renderCompetenciesTags();
                renderCompetenciesOptions();
            }

            // Limpar e recriar opções
            const container = document.getElementById('options-container');
            const label = container.querySelector('.form-label');
            const btnAdd = container.querySelector('.btn-add-option');

            // Remove todas as opções existentes
            container.querySelectorAll('.option-item').forEach(item => item.remove());

            // Adiciona as novas opções
            question.options.forEach((option, index) => {
                const optionNum = index + 1;
                const newOption = document.createElement('div');
                newOption.className = 'option-item';
                newOption.innerHTML = `
                        <span class="option-number">${optionNum}</span>
                        <div class="radio-btn ${option.right ? 'checked' : ''}" data-option="${optionNum}"></div>
                        <input type="text" class="option-input ${option.right ? 'correct' : ''}" data-option="${optionNum}" value="${option.text}">
                        <button class="btn-delete" onclick="deleteOption(${optionNum})">🗑️</button>
                    `;
                container.insertBefore(newOption, btnAdd);
            });

            optionCount = question.options.length;
            correctOption = question.options.findIndex(o => o.correta) + 1;

            // Carregar media
            loadMedia(question.media || []);

            // Reinicializar eventos
            initRadioButtons();

            // Atualizar lista de questões na sidebar
            document.querySelectorAll('.question-item').forEach(item => {
                item.classList.remove('active');
                if (parseInt(item.getAttribute('data-question')) === questionId) {
                    item.classList.add('active');
                }
            });
        }

        // Função para salvar questão atual
        function saveActualQuestion() {
            const description = document.getElementById('description').value;
            const options = [];

            document.querySelectorAll('.option-item').forEach(item => {
                const input = item.querySelector('.option-input');
                const radio = item.querySelector('.radio-btn');
                options.push({
                    text: input.value,
                    right: radio.classList.contains('checked')
                });
            });

            questionsData[currentQuestionId] = {
                competencies: questionsData[currentQuestionId].competencies || [],
                description,
                options,
                media: questionsData[currentQuestionId].media || []
            };
        }

        // Função para adicionar nova questão
        function addQuestion() {
            // Salvar questão atual
            saveActualQuestion();

            // Criar nova questão
            const newQuestionId = Object.keys(questionsData).length + 1;
            questionsData[newQuestionId] = {
                competency: [],
                description: "Descrição do cenário...",
                options: [
                    { text: "Opção 1", right: true },
                    { text: "Opção 2", right: false }
                ],
                media: []
            };

            // Adicionar à lista na sidebar
            const questionList = document.getElementById('question-list');
            const newItem = document.createElement('li');
            newItem.className = 'question-item';
            newItem.setAttribute('data-question', newQuestionId);
            newItem.setAttribute('onclick', `loadQuestion(${newQuestionId})`);
            newItem.innerHTML = `
                    <span class="question-number">${newQuestionId}</span>
                    Nova Questão
                `;
            questionList.appendChild(newItem);

            // Atualizar contador
            document.getElementById('question-count').textContent = Object.keys(questionsData).length;

            // Carregar a nova questão
            loadQuestion(newQuestionId);
        }

        // Gerenciamento de Media
        function loadMedia(mediaArray) {
            const mediaGrid = document.getElementById('media-grid');
            mediaGrid.innerHTML = '';

            if (!mediaArray || mediaArray.length === 0) {
                return;
            }

            mediaArray.forEach((media, index) => {
                const mediaItem = document.createElement('div');
                mediaItem.className = 'media-item';

                let content = '';

                if (media.type === 'image') {
                    content = `
                            <div class="media-item-content">
                                <img src="${media.url}" alt="Imagem ${index + 1}" onerror="this.parentElement.innerHTML='<div class=\\'media-error\\'>Erro ao carregar imagem</div>'">
                            </div>
                            <button class="media-delete" onclick="deleteMedia(${index})">🗑️</button>
                            <span class="media-type-badge">Imagem</span>
                        `;
                } else if (media.type === 'video') {
                    content = `
                            <div class="media-item-content">
                                <video src="${media.url}" controls onerror="this.parentElement.innerHTML='<div class=\\'media-error\\'>Erro ao carregar vídeo</div>'"></video>
                            </div>
                            <button class="media-delete" onclick="deleteMedia(${index})">🗑️</button>
                            <span class="media-type-badge">Vídeo</span>
                        `;
                }

                mediaItem.innerHTML = content;
                mediaGrid.appendChild(mediaItem);
            });
        }

        
        // Abrir modal para adicionar URL
        function addMediaURL() {
            document.getElementById('media-modal').classList.add('active');
            document.getElementById('media-url-input').value = '';
            document.getElementById('media-type-select').value = 'image';
            document.getElementById('media-url-input').focus();
            document.getElementById('media-caption-input').value = '';
        }


        // Fechar modal
        function closeMediaModal() {
            document.getElementById('media-modal').classList.remove('active');
        }

        // Confirmar e adicionar URL
        function confirmMediaURL() {
            const url = document.getElementById('media-url-input').value.trim();
            const type = document.getElementById('media-type-select').value;
            const caption = document.getElementById('media-caption-input').value.trim();

            if (!url) {
                alert('Por favor, insira um URL válido!');
                return;
            }

            // Validação básica de URL
            try {
                new URL(url);
            } catch (e) {
                alert('URL inválido! Certifique-se de incluir http:// ou https://');
                return;
            }

            // Adicionar ao array de media da questão atual
            if (!questionsData[currentQuestionId].media) {
                questionsData[currentQuestionId].media = [];
            }

            questionsData[currentQuestionId].media.push({
                type: type,
                url: url,
                caption : caption
            });

            // Recarregar media
            loadMedia(questionsData[currentQuestionId].media);

            // Fechar modal
            closeMediaModal();
        }

        // Fechar modal ao clicar fora
        document.getElementById('media-modal').addEventListener('click', function (e) {
            if (e.target === this) {
                closeMediaModal();
            }
        });

        // Adicionar suporte para Enter no input
        document.getElementById('media-url-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                confirmURLMedia();
            }
        });

        // Fechar modal com ESC
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('media-modal');
                if (modal.classList.contains('active')) {
                    closeMediaModal();
                }
            }
        });

        // Função para deletar media por índice
        function deleteMedia(index) {
            const question = questionsData[currentQuestionId];
            if (question && question.media) {
                question.media.splice(index, 1);
                loadMedia(question.media);
            }
        }

        // Função para adicionar nova opção
        document.querySelector('.btn-add-option').addEventListener('click', function () {
            optionCount++;
            const optionsContainer = document.getElementById('options-container');
            const newOption = document.createElement('div');
            newOption.className = 'option-item';
            newOption.innerHTML = `
                    <span class="option-number">${optionCount}</span>
                    <div class="radio-btn" data-option="${optionCount}"></div>
                    <input type="text" class="option-input" data-option="${optionCount}" placeholder="Digite a opção de resposta...">
                    <button class="btn-delete" onclick="deleteOption(${optionCount})">🗑️</button>
                `;

            optionsContainer.insertBefore(newOption, this);

            const newRadio = newOption.querySelector('.radio-btn');
            newRadio.addEventListener('click', function () {
                const optionId = this.getAttribute('data-option');

                document.querySelectorAll('.radio-btn').forEach(b => b.classList.remove('checked'));
                document.querySelectorAll('.option-input').forEach(input => {
                    input.classList.remove('correct');
                });

                this.classList.add('checked');
                document.querySelector(`.option-input[data-option="${optionId}"]`).classList.add('correct');
                correctOption = parseInt(optionId);
            });
        });

        // Função para deletar opção
        function deleteOption(optionId) {
            const options = document.querySelectorAll('.option-item');
            if (options.length <= 2) {
                alert('É necessário ter pelo menos 2 opções de resposta!');
                return;
            }

            const optionToDelete = document.querySelector(`.option-item .radio-btn[data-option="${optionId}"]`).closest('.option-item');
            optionToDelete.remove();

            const remainingOptions = document.querySelectorAll('.option-item');
            remainingOptions.forEach((option, index) => {
                const number = index + 1;
                option.querySelector('.option-number').textContent = number;
                option.querySelector('.radio-btn').setAttribute('data-option', number);
                option.querySelector('.option-input').setAttribute('data-option', number);
            });

            optionCount = remainingOptions.length;
        }

        // Função para salvar tudo
        document.querySelector('.btn-save').addEventListener('click', async function () {
            saveActualQuestion();

            // Preparar dados para envio à API
            const payload = prepareDataForAPI();

            // Mostrar loading
            document.getElementById('loading-overlay').classList.add('active');

            try {
                const apiUrl = API_BASE + '/api/question/';

                // Preparar headers
                const headers = {
                    'Content-Type': 'application/json'
                };

                // Fazer requisição à API
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(payload)
                });

                // Esconder loading
                document.getElementById('loading-overlay').classList.remove('active');

                if (!response.ok) {
                    throw new Error(`Erro na API: ${response.status} - ${response.statusText}`);
                }

                alert('✅ Alterações guardadas com sucesso!\n\nTotal de questões: ' + Object.keys(questionsData).length);

            } catch (error) {
                document.getElementById('loading-overlay').classList.remove('active');

                console.error('Erro ao guardar:', error);
                alert('❌ Erro ao guardar alterações:\n\n' + error.message + '\n\nVerifique o console para mais detalhes.');

                console.log('Dados que seriam enviados:', payload);
            }
        });

        function prepareDataForAPI() {
            const questions = [];

            Object.keys(questionsData).forEach(questionId => {
                const q = questionsData[questionId];

                const correctAwnserIndex = q.options.findIndex(option => option.right);

                const competenciesInfo = Array.isArray(q.competencies) ? q.competencies.map(id => parseInt(id, 10)) : [];

                const question = {
                    id: parseInt(questionId),
                    competencies: competenciesInfo,
                    description: q.description,
                    options: q.options.map((option, index) => ({
                        id: index + 1,
                        text: option.text
                    })),
                    rightAwnser: correctAwnserIndex + 1, // Índice baseado em 1
                };

                // Adicionar recursos multimédia se existirem
                if (q.media && q.media.length > 0) {
                    question.mediaResources = q.media.map((media, index) => ({
                        id: index + 1,
                        type: media.type,
                        url: media.url, 
                        caption: media.caption
                    }));
                }

                questions.push(question);
            });

            return {
                scenario: document.querySelector('.sidebar-input').value || "Chefe de Grupo",
                totalQuestions: questions.length,
                questions: questions,
            };
        }

        initialize();
    </script>
</body>
</html>